<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
<meta name="msvalidate.01" content="67E7EDB1C51D8636FBFDE580F4C6BFD1" />
<meta name="baidu-site-verification" content="SS7G439MNv" />
<title>
  A benchmark on mapping few keys |  Static Oneplus
</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
<!--<link rel="stylesheet" href=""> -->
<style type="text/css">
.prettyprint ol.linenums > li { list-style-type: decimal; }
.nav { }
.nav li { float: left; width: 70px; }
.content { padding: 30px 0; }
body, h1, h2, h3, h4 { font-family: "Fjalla One","Georgia","Helvetica Neue",Arial,sans-serif;}
header { width: 100%; height: 80px;}
blockquote p { font-size: 14px; }
</style>
</head>
<body>

<div class="container">
  <header class="header">
    <h1 class="site_title">Static Oneplus <small>不可控制论</small></h1>
    <ul class="nav pull-right">
      <li><a href="/">Home</a></li>
      <li><a href="/cv">CV</a></li>
      <li><a href="/blog">Blog</a></li>
      <li><a href="/notes">Notes</a></li>
      <li><a href="/feed.xml">RSS</a></li>
    </ul>
  </header>

  <div class="content">
    <div style="color:#999;">
  <small>2015/03/10 - by
    Oneplus

      &bull; <a href="/blog/tags/c.html">C++</a>
      &bull; <a href="/blog/tags/associative-container.html">associative container</a>
  </small>
</div>
<h2>A benchmark on mapping few keys</h2>
<hr />
<div>
  <p>Recently, I’ve worked on optimizing my transition-based parser and came across such situation:</p>

<blockquote>
  <p>I need an associated, or key-value, structure to store the cached scored for each transition action at a certain state.
In practice, the number of transition actions is relatively small (less than 100), so I became curious about the best associated data structure for small set of keys.</p>
</blockquote>

<p>Previous posts on such performance benchmark mainly focus on the comparsion of different hash maps on large scale, like <a href="http://incise.org/hash-table-benchmarks.html">this one</a>.
This post differs from theirs by setting the number of keys to a small number.
Time consumption on <em>random insertion</em>, <em>ordered insertion</em>, <em>random retrieve</em> and <em>ordered retrieve</em> is evaluated.
I didn’t give a try on the <em>delete</em> operation cause there is no such operation in my problems.</p>

<p>Three types of mapping facilities are adopted in this posts.
They are:</p>

<ul>
  <li><strong>Tree</strong>: <code>std::map</code></li>
  <li><strong>Ordered List</strong>: <code>boost::container::flat_map</code></li>
  <li><strong>Hashtable</strong>: <code>std::unordered_map</code>, <code>boost::unordered_map</code>, <code>google::sparse_hash_map</code>, <code>google::dense_hash_map</code></li>
</ul>

<p><code>std::map</code> is a several-time loser in previous benchmark because of the O(log n) time complexity.
I choose the <code>std::map</code> and hope it can win a round in this special situation.
<code>boost::container::flat_map</code> is suggested by <a href="http://stackoverflow.com/questions/15625225/map-vs-unordered-map-for-few-elements">this StackOverflow question</a>.
It seems the key are ordered and stored in a list in <code>boost::container::flat_map</code>, rather than a tree like the <code>std::map</code> does.
Expectingly, this data structure should have some nice memory allocation feature compared with the <code>std::map</code>.
The <strong>Hashtable</strong> group is actually my old friends and I used <code>google::dense_hash_map</code> and <code>std::unordered_map</code> a lot.</p>

<h3 id="results">Results</h3>

<p>All the experiments are conducted on a Xeon(R) CPU E5-2620 @ 2.00GHz server.
My GCC is a new-version one, the 4.8.2.
The code used in this benchmark can be found at <a href="https://gist.github.com/Oneplus/95aca812db7df06db4a6">this gist</a>.
<code>-O3</code> optimizing level is configured in compling the code.</p>

<p>The benchmark results are shown below.</p>

<script language="javascript" type="text/javascript" src="http://flot.googlecode.com/svn/trunk/jquery.js"></script>

<script language="javascript" type="text/javascript" src="http://flot.googlecode.com/svn/trunk/jquery.flot.js"></script>

<script>
series_settings = {
    lines: { show: true },
    points: { show: true }
};
grid_settings = { tickColor: '#ddd' };
xaxis_settings = {
    tickSize: 5,
    tickFormatter: function(num, obj) { return num; }
};
yaxis_runtime_settings = {
    tickSize: 3,
    tickFormatter: function(num, obj) { return num + ' sec.'; }
};
legend_settings = {
    position: 'nw',
    backgroundOpacity: 0
};
runtime_settings = {
    series: series_settings,
    grid: grid_settings,
    xaxis: xaxis_settings,
    yaxis: yaxis_runtime_settings,
    legend: legend_settings
};

chart_data = {"insert_ordered": [{"data": [[7, 0.409322], [10, 0.585166], [22, 1.341716], [34, 2.139042], [44, 3.038083], [59, 4.370022], [68, 4.935407], [77, 5.307655], [84, 5.844386], [94, 6.582139], [108, 8.13809], [117, 8.708292], [128, 9.185893]], "label": "GCC 4.8.2 std::map"}, {"data": [[7, 0.519962], [10, 0.759663], [22, 1.858168], [34, 3.708597], [44, 4.137573], [59, 7.066421], [68, 7.991669], [77, 8.343582], [84, 7.938728], [94, 8.793034], [108, 13.404046], [117, 13.88253], [128, 14.58537]], "label": "GCC 4.8.2 std::unordered_map"}, {"data": [[7, 0.550035], [10, 1.051826], [22, 2.03427], [34, 5.646686], [44, 6.974083], [59, 14.161613], [68, 15.367167], [77, 16.903076], [84, 16.48261], [94, 21.557487], [108, 38.543933], [117, 41.327302], [128, 39.764304]], "label": "Google sparsehash 2.0 sparse_hash_map"}, {"data": [[7, 0.164327], [10, 0.196777], [22, 0.672963], [34, 1.394658], [44, 1.434241], [59, 1.797652], [68, 2.955158], [77, 2.562484], [84, 2.776381], [94, 2.985307], [108, 3.199112], [117, 3.242178], [128, 3.226103]], "label": "Google sparsehash 2.0 dense_hash_map"}, {"data": [[7, 0.633299], [10, 0.889551], [22, 2.800967], [34, 4.726608], [44, 5.401382], [59, 8.81247], [68, 9.751447], [77, 9.189723], [84, 10.183168], [94, 12.195744], [108, 15.87413], [117, 15.845215], [128, 16.748076]], "label": "Boost 1.57 unordered_map"}, {"data": [[7, 0.439004], [10, 0.54523], [22, 0.648596], [34, 1.187385], [44, 1.370228], [59, 1.634742], [68, 2.006426], [77, 2.029157], [84, 2.198808], [94, 2.398985], [108, 2.659591], [117, 2.662692], [128, 2.822689]], "label": "Boost 1.57 container/flat_map"}], "query_ordered": [{"data": [[7, 0.442178], [10, 0.504482], [22, 0.637969], [34, 0.661629], [44, 0.758225], [59, 0.828777], [68, 0.842935], [77, 0.842343], [84, 0.834386], [94, 0.854975], [108, 0.918758], [117, 0.885608], [128, 0.889101]], "label": "GCC 4.8.2 std::map"}, {"data": [[7, 2.992673], [10, 3.446545], [22, 3.726248], [34, 3.118768], [44, 3.825269], [59, 3.088826], [68, 3.323022], [77, 3.39234], [84, 3.532552], [94, 3.777222], [108, 2.875106], [117, 2.94179], [128, 3.004405]], "label": "GCC 4.8.2 std::unordered_map"}, {"data": [[7, 1.406637], [10, 1.907112], [22, 3.981396], [34, 3.729011], [44, 5.419971], [59, 3.247684], [68, 3.848389], [77, 4.635114], [84, 4.906134], [94, 5.902078], [108, 3.05959], [117, 3.217729], [128, 3.553654]], "label": "Google sparsehash 2.0 sparse_hash_map"}, {"data": [[7, 0.71078], [10, 1.003725], [22, 1.015675], [34, 0.885142], [44, 1.093953], [59, 1.473621], [68, 0.883818], [77, 0.965263], [84, 0.941491], [94, 1.194417], [108, 1.392917], [117, 1.469674], [128, 1.496883]], "label": "Google sparsehash 2.0 dense_hash_map"}, {"data": [[7, 2.763566], [10, 3.279529], [22, 3.674283], [34, 3.613969], [44, 3.944727], [59, 3.576254], [68, 3.843012], [77, 3.70055], [84, 3.951947], [94, 4.445336], [108, 3.424645], [117, 3.374889], [128, 3.504379]], "label": "Boost 1.57 unordered_map"}, {"data": [[7, 0.578214], [10, 0.640305], [22, 0.796682], [34, 0.940796], [44, 1.019577], [59, 1.089206], [68, 1.095279], [77, 1.069663], [84, 1.071094], [94, 1.17977], [108, 1.184879], [117, 1.158933], [128, 1.239591]], "label": "Boost 1.57 container/flat_map"}], "insert_random": [{"data": [[7, 0.453461], [10, 0.636787], [22, 1.431945], [34, 2.409063], [44, 3.279204], [59, 4.396479], [68, 5.259939], [77, 5.70331], [84, 6.175281], [94, 6.765964], [108, 8.568328], [117, 9.25607], [128, 9.453532]], "label": "GCC 4.8.2 std::map"}, {"data": [[7, 0.520997], [10, 0.795826], [22, 1.849433], [34, 3.595913], [44, 4.257769], [59, 6.986665], [68, 7.913297], [77, 8.298659], [84, 7.833349], [94, 8.508522], [108, 12.582747], [117, 13.721128], [128, 14.607924]], "label": "GCC 4.8.2 std::unordered_map"}, {"data": [[7, 0.542842], [10, 1.048864], [22, 2.033791], [34, 5.626442], [44, 7.351983], [59, 14.587265], [68, 15.385357], [77, 16.365351], [84, 16.184529], [94, 18.344505], [108, 41.227187], [117, 39.37891], [128, 40.724853]], "label": "Google sparsehash 2.0 sparse_hash_map"}, {"data": [[7, 0.164012], [10, 0.196725], [22, 0.674874], [34, 1.378056], [44, 1.457056], [59, 1.766007], [68, 2.83264], [77, 2.559138], [84, 2.73269], [94, 2.969715], [108, 3.183305], [117, 3.099282], [128, 3.314104]], "label": "Google sparsehash 2.0 dense_hash_map"}, {"data": [[7, 0.62334], [10, 0.896382], [22, 2.836475], [34, 4.820623], [44, 5.454768], [59, 8.68892], [68, 9.822701], [77, 9.247], [84, 10.225132], [94, 12.206556], [108, 15.684576], [117, 15.788265], [128, 16.734827]], "label": "Boost 1.57 unordered_map"}, {"data": [[7, 0.438406], [10, 0.549438], [22, 0.69154], [34, 1.324668], [44, 1.767032], [59, 2.356399], [68, 3.339673], [77, 3.618639], [84, 3.978056], [94, 4.786716], [108, 5.719606], [117, 6.410732], [128, 7.284667]], "label": "Boost 1.57 container/flat_map"}], "query_random": [{"data": [[7, 1.437126], [10, 1.780534], [22, 2.134941], [34, 2.592437], [44, 3.032842], [59, 3.384666], [68, 3.2827], [77, 3.150921], [84, 3.359862], [94, 3.607361], [108, 4.09756], [117, 3.97718], [128, 3.939264]], "label": "GCC 4.8.2 std::map"}, {"data": [[7, 2.994385], [10, 3.449125], [22, 3.717252], [34, 3.119746], [44, 3.807377], [59, 3.093871], [68, 3.303348], [77, 3.401457], [84, 3.536373], [94, 3.763217], [108, 2.871974], [117, 2.917151], [128, 2.999574]], "label": "GCC 4.8.2 std::unordered_map"}, {"data": [[7, 1.408497], [10, 1.912621], [22, 3.993406], [34, 3.627917], [44, 5.541751], [59, 3.285898], [68, 3.889345], [77, 4.694517], [84, 4.95274], [94, 5.960179], [108, 3.090273], [117, 3.26882], [128, 3.579417]], "label": "Google sparsehash 2.0 sparse_hash_map"}, {"data": [[7, 0.712499], [10, 1.006673], [22, 1.014273], [34, 0.879282], [44, 1.097076], [59, 1.484884], [68, 0.884689], [77, 0.967289], [84, 0.941574], [94, 1.203366], [108, 1.402282], [117, 1.488052], [128, 1.504695]], "label": "Google sparsehash 2.0 dense_hash_map"}, {"data": [[7, 2.765428], [10, 3.28057], [22, 3.668774], [34, 3.626416], [44, 3.907296], [59, 3.550368], [68, 3.809431], [77, 3.702852], [84, 3.959559], [94, 4.435955], [108, 3.419833], [117, 3.369579], [128, 3.506896]], "label": "Boost 1.57 unordered_map"}, {"data": [[7, 1.643326], [10, 1.924941], [22, 2.233269], [34, 2.909318], [44, 3.297877], [59, 3.558162], [68, 3.54885], [77, 3.31426], [84, 3.584803], [94, 3.906225], [108, 4.057794], [117, 3.841046], [128, 4.066772]], "label": "Boost 1.57 container/flat_map"}]}
$(function () {
    $.plot($("#query_random"), chart_data['query_random'], runtime_settings);
    $.plot($("#query_ordered"), chart_data['query_ordered'], runtime_settings);
    $.plot($("#insert_random"), chart_data['insert_random'], runtime_settings);
    $.plot($("#insert_ordered"), chart_data['insert_ordered'], runtime_settings);
});
</script>

<style>
div.chart {
    width: 700px;
    height: 230px;
}
div.xaxis-title {
    width: 700px;
    text-align: center;
    font-style: italic;
    font-size: small;
    color: #666;
}
</style>

<p>Ordered insertion</p>

<div class="chart" id="insert_ordered"></div>
<div class="xaxis-title">number of keys</div>

<p>Random insertion</p>

<div class="chart" id="insert_random"></div>
<div class="xaxis-title">number of keys</div>

<p>Ordered queries</p>

<div class="chart" id="query_ordered"></div>
<div class="xaxis-title">number of keys</div>

<p>Random queries</p>

<div class="chart" id="query_random"></div>
<div class="xaxis-title">number of keys</div>

<h3 id="summary">Summary</h3>
<p>Generally speaking, the <code>google::dense_hash_map</code> is still the best choice if you are aggressively purchasing the speed performance.
Experimental result confirms that the <code>dense_hash_map</code> achieves both the fastest insertion and fastest querying.</p>

<p>Also, we see that on the condition that the number of keys is relatively small, the sorted group (<code>std::map</code> and <code>boost::container::flat_map</code>) performs better than the hash group.
One thing we need to note that, after the number of key increase to about 100, the sorted group starts to perform poor compared to the hash group.</p>

<p>By comparing the <code>std::map</code> and <code>boost::container::flat_map</code>, their performances are almost identical.
I am a little disappointed by this fact because I always considering the <code>boost::container::flat_map</code> as a silver bullet for the few key mapping problems.</p>

<p>For practice, there are several suggestion:</p>

<ul>
  <li>For the mapping problem with less than 100 keys, <code>std::map</code> is still a solution. It’s especially true if ordered keys is in your concern.</li>
  <li><code>google::dense_hash_map</code> is still number one choice, if memory and the annoying <code>set_empty_key()</code> are both not the problems.</li>
</ul>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = 'yjliu'; // required: replace example with your forum shortname
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>

  <footer class="text-center">
    &copy; <a href="http://yjliu.net/">Static Oneplus</a> 2010 - 2015 |
    This site is built by <a href="http://middlemanapp.com/" target="_blank">Middleman</a> and
    <a href="http://getbootstrap.com/">bootstrap</a>.
  </footer>
</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-20774106-1', 'yjliu.net');
ga('send', 'pageview');
</script>
<script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>
</body>
</html>
